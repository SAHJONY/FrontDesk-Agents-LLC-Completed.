import { NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { autonomousBusinessSetup } from '@/lib/ai/crawler'; 

export async function POST(req: Request) {
  const { url } = await req.json();

  // 1. Ejecutar el Crawler Avanzado que ya construimos
  const businessData = await autonomousBusinessSetup(url);

  // 2. Guardar en la base de datos vinculando al usuario
  const savedConfig = await db.businessConfig.upsert({
    where: { userId: 'id-del-usuario-actual' }, // Esto vendr√≠a de Clerk/Auth
    update: {
      businessName: businessData.business_name,
      services: businessData.services,
      businessHours: businessData.business_hours,
      faq: businessData.faq,
      websiteUrl: url,
    },
    create: {
      userId: 'id-del-usuario-actual',
      businessName: businessData.business_name,
      services: businessData.services,
      businessHours: businessData.business_hours,
      websiteUrl: url,
    }
  });

  return NextResponse.json(savedConfig);
}
