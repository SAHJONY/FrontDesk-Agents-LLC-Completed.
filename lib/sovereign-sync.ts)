import { createClient } from "@supabase/supabase-js";
import { Redis } from "@upstash/redis";

const redis = new Redis({
  url: process.env.REDIS_URL!,
  token: process.env.REDIS_TOKEN!,
});

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Use Service Role to bypass RLS for syncing
);

/**
 * SOVEREIGN SYNC PROTOCOL
 * Synchronizes usage data across the cache and database layers.
 */
export async function syncTenantStatus(tenantId: string) {
  try {
    // 1. Fetch current ground truth from Supabase
    const { data: tenant, error } = await supabase
      .from('tenants')
      .select('owner_id, used_minutes, max_minutes, subscription_status')
      .eq('id', tenantId)
      .single();

    if (error || !tenant) throw new Error("Tenant sync failed: Record not found");

    const userId = tenant.owner_id;
    const isExhausted = tenant.used_minutes >= tenant.max_minutes;
    const isDelinquent = tenant.subscription_status === 'past_due' || tenant.subscription_status === 'canceled';

    // 2. Update Redis Block List
    if (isExhausted) {
      await redis.set(`block:${userId}`, 'EXHAUSTED', { ex: 86400 }); // 24hr cache
      console.log(`[SYNC] Tenant ${tenantId} blocked: Minute Exhaustion`);
    } else if (isDelinquent) {
      await redis.set(`block:${userId}`, 'PAST_DUE', { ex: 86400 });
      console.log(`[SYNC] Tenant ${tenantId} blocked: Payment Delinquency`);
    } else {
      // 3. Clear block if status is healthy
      await redis.del(`block:${userId}`);
      console.log(`[SYNC] Tenant ${tenantId} status: Operational`);
    }

    return { success: true };
  } catch (err) {
    console.error("Critical Sync Error:", err);
    return { success: false };
  }
}
