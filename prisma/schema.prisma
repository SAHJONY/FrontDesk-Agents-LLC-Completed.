generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. BUSINESS & WORKSPACE (The Tenant Identity)
model BusinessConfig {
  id                String   @id @default(cuid())
  userId            String   @unique
  businessName      String?
  industry          String?  // 'Medical', 'Legal', 'Trades', etc.
  websiteUrl        String?
  
  // Custom CRM Fields (Vertical Specific)
  // Stores industry-specific data points like 'Patient ID' or 'Case Type'
  customSchema      Json?    @default("{}") 
  
  // Intelligence Config
  services          String[]
  businessHours     Json?    
  faq               Json?    
  toneOfVoice       String   @default("profesional y amable")
  cancellationPolicy String?

  // Connectivity
  phoneNumber       String?  @unique
  blandInboundId    String?  
  
  // Market Localization (Worldwide Upgrade)
  locale            String   @default("en-US")
  currency          String   @default("USD")

  // Subscription
  paymentProvider   String?  
  subscriptionId    String?  @unique
  status            String   @default("pending")
  
  // CRM Relations
  calls             CallLog[]
  leads             Lead[]       // New: The Sovereign CRM Lead Bank
  pipelines         Pipeline[]   // New: Industry-specific sales stages
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// 2. SOVEREIGN CRM LEADS (The Client's Proprietary Database)
model Lead {
  id              String   @id @default(cuid())
  businessId      String
  business        BusinessConfig @relation(fields: [businessId], references: [id])
  
  firstName       String?
  lastName        String?
  phone           String
  email           String?
  
  // AI Lead Scoring
  status          String   @default("NEW") // "QUALIFIED", "BOOKED", "LOST", "NURTURE"
  leadScore       Int      @default(0)     // 0-100 based on SARA's evaluation
  industryData    Json?    @default("{}")  // Specifics like 'Dental_Procedure_Type'
  
  lastContacted   DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([phone])
}

// 3. PIPELINE STAGES (Vertical-Specific Workflows)
model Pipeline {
  id              String   @id @default(cuid())
  businessId      String
  business        BusinessConfig @relation(fields: [businessId], references: [id])
  name            String   // 'Intake', 'Consultation', 'Contract Signed'
  order           Int      @default(0)
}

// 4. FORENSIC CALL LOGS (Linked to CRM Leads)
model CallLog {
  id              String   @id @default(cuid())
  businessId      String
  business        BusinessConfig @relation(fields: [businessId], references: [id])
  
  customerPhone   String
  callDuration    Int?      
  transcript      String?   @db.Text
  summary         String?   @db.Text
  
  // Post-Call Intelligence
  wasBooked       Boolean  @default(false)
  sentiment       String?   
  estimatedValue  Float    @default(0.0)
  
  blandCallId     String   @unique
  recordingUrl    String?
  
  createdAt       DateTime @default(now())
}

// 5. INFRASTRUCTURE CONTROL (Daily Guard)
model IntegrationsControl {
  id            String   @id @default("bland_ai")
  provider      String   @unique @default("bland_ai")
  enabled       Boolean  @default(true)
  daily_limit   Int      @default(100)
}

model PlatformStats {
  id              Int      @id @default(1)
  totalCalls      Int      @default(0)
  totalBookings   Int      @default(0)
  totalRevenue    Float    @default(0.0)
  lastUpdated     DateTime @updatedAt
}
