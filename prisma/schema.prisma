// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. CONFIGURACIÓN DEL NEGOCIO (Lo que el Crawler llena)
model BusinessConfig {
  id                String   @id @default(cuid())
  userId            String   @unique // ID del usuario (Clerk/Supabase Auth)
  businessName      String?
  industry          String?
  websiteUrl        String?
  
  // Datos extraídos por la IA
  services          String[] // Lista de servicios
  businessHours     Json?    // {weekdays: "9am-6pm", weekends: "10am-2pm"}
  faq               Json?    // Preguntas y respuestas en formato JSON
  toneOfVoice       String   @default("profesional y amable")
  cancellationPolicy String?

  // Telefonía (Bland AI)
  phoneNumber       String?  @unique // El número asignado al negocio
  blandInboundId    String?  // ID de configuración en Bland AI

  // Estado de Pago y Suscripción (Stripe o Square)
  paymentProvider   String?  // "stripe" o "square"
  subscriptionId    String?  @unique
  status            String   @default("pending") // "active", "canceled", "pending", "past_due"
  
  // Relaciones
  calls             CallLog[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// 2. REGISTRO DE LLAMADAS (Lo que el Post-Call Webhook llena)
model CallLog {
  id              String   @id @default(cuid())
  businessId      String
  business        BusinessConfig @relation(fields: [businessId], references: [id])
  
  customerPhone   String
  callDuration    Int?      // En segundos
  transcript      String?   @db.Text
  summary         String?   @db.Text
  
  // Analítica de la IA
  wasBooked       Boolean  @default(false)
  sentiment       String?   // "positive", "neutral", "negative"
  estimatedValue  Float    @default(0.0)
  
  // Datos de Bland AI
  blandCallId     String   @unique
  recordingUrl    String?
  
  createdAt       DateTime @default(now())
}

// 3. ANALÍTICAS GLOBALES (Opcional, para el Admin Dashboard)
model PlatformStats {
  id              Int      @id @default(1)
  totalCalls      Int      @default(0)
  totalBookings   Int      @default(0)
  totalRevenue    Float    @default(0.0)
  lastUpdated     DateTime @updatedAt
}
