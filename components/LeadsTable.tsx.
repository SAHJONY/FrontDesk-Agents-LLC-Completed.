'use client';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase/client';

interface Lead {
  id: string;
  full_name: string;
  company_name: string;
  industry: string;
  lead_score: number;
  created_at: string;
}

export default function LeadsTable() {
  const [leads, setLeads] = useState<Lead[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchLeads = async () => {
      const { data, error } = await supabase
        .from('leads')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching leads:', error.message);
      } else {
        setLeads(data || []);
      }
      setLoading(false);
    };

    fetchLeads();

    // Set up real-time listener
    const channel = supabase
      .channel('schema-db-changes')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'leads' },
        (payload) => {
          setLeads((prev) => [payload.new as Lead, ...prev]);
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  if (loading) return <p className="text-gray-500">Loading leads...</p>;

  return (
    <div className="mt-8 overflow-hidden border border-gray-200 rounded-lg shadow-sm">
      <table className="min-w-full divide-y divide-gray-200 bg-white text-left text-sm">
        <thead className="bg-gray-50 text-gray-700 uppercase font-semibold">
          <tr>
            <th className="px-4 py-3">Name</th>
            <th className="px-4 py-3">Company</th>
            <th className="px-4 py-3">Industry</th>
            <th className="px-4 py-3 text-center">Score</th>
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-200 text-gray-900">
          {leads.map((lead) => (
            <tr key={lead.id} className="hover:bg-gray-50 transition-colors">
              <td className="px-4 py-3 font-medium">{lead.full_name}</td>
              <td className="px-4 py-3">{lead.company_name || 'N/A'}</td>
              <td className="px-4 py-3">{lead.industry}</td>
              <td className="px-4 py-3 text-center">
                <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                  lead.lead_score >= 80 ? 'bg-green-100 text-green-700' : 
                  lead.lead_score >= 60 ? 'bg-yellow-100 text-yellow-700' : 
                  'bg-gray-100 text-gray-700'
                }`}>
                  {lead.lead_score}
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      {leads.length === 0 && (
        <div className="p-8 text-center text-gray-500">No leads found. Use the form to add one!</div>
      )}
    </div>
  );
}
